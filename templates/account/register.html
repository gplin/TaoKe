{% extends "base.html" %}
{% block content %}
<H1>注册</H1>
<div class="form-horizontal">
	<div class="control-group">
		<label class="control-label" for="email">邮箱地址:</label>
		<div class="controls">
			<input type="text" id="email" placeholder="sample@qq.com"/>
			<span class="help-inline" style="display:none;">请输入邮箱地址</span>
		</div>
	</div>
	<div class="control-group">
		<label class="control-label" for="nickname">昵称:</label>
		<div class="controls">
			<input type="text" id="nickname" placeholder="小清新mm"/>
			<span class="help-inline" style="display:none;">请输入昵称</span>
		</div>
	</div>
	<div class="control-group">
		<label class="control-label" for="pwd">设置密码:</label>
		<div class="controls">
			<input type="password" id="pwd" placeholder="Password"/>
			<span class="help-inline" style="display:none;">密码长度6-20位</span>
		</div>
	</div>
	<div class="control-group">
		<label class="control-label" for="repwd">确认密码:</label>
		<div class="controls">
			<input type="password" id="repwd" placeholder="Confirm Password"/>
			<span class="help-inline" style="display:none;"></span>
		</div>
	</div>
	<div class="control-group">
		<div class="controls">
	<input type="button" id="reg"  class="btn btn-success" data-loading-text="正在处理..." value="注册" />
	<input type="reset" id="reset" class="btn btn-success" value="重置" />
		</div>
	</div>
</div>
{% endblock %}
{% block footer_javascript %}
<script>
		$(function($){
			// alert("ready");
			
		});
		// function changeCaptcha() {
		// 	$("#authCode").attr('value', '');
		// 	$("#img_captcha").attr('src', 'http://t.hd.xiaomi.com/?_a=20130820&_op=authcode&_r=' + Math.random());
		// }
		/**
		 * 验证手机号码
		 */
		// function checkMobile(mobile) {
		// 	var patrn = /^1[3|4|5|8][0-9]\d{8}$/;	// 11 位手机
		// 	//var patrn = /^\d{11,}$/;	// 11 位以上数字
		// 	if(!patrn.exec(mobile)) {
		// 		return false;
		// 	} else {
		// 		return true;
		// 	};
		// };

		/**
		 * 验证邮箱格式
		 */
		function checkMailFormat(mail) {
			var patrn = /^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/;
			if(!patrn.exec(mail)) {
				return false;
			} else {
				return true;
			};
		};

		/**
		 * 验证是否为中文
		 */
		// function checkCn(string) {
		// 	var patrn = /^[\u4e00-\u9fa5]+$/;
		// 	if(!patrn.exec(string)) {
		// 		return false;
		// 	} else {
		// 		return true;
		// 	};
		// };

		/**
		 * 返回字符串长度，中文字符算作两个
		 */
		function len(str){
			return str.replace(/[^\x00-\xff]/g,"aa").length;
		};

		var newAccount = function(event) {
			if(!checkEmail()){
				$("#email").focus();
				return
			}
			if(!checkPwd()){
				$("#pwd").focus();
				return 
			}
			if(!checkRepwd()){
				$("#repwd").focus()
				return 
			}
			// console.log("new account");
			// $("#reg").attr("disabled",true);
			// alert("reg")
			// return false;
			// $("#reset").focus();

			$.ajax({
				type:"POST",
				dataType:"json",
				url:"/account/register/",
				cache:false,
				data:{email:$("#email").val(),pwd:$("#pwd").val(),nickname:$("#nickname").val()},
				success:function(data,textStatus){
					// alert(textStatus)
					if(data.result=="success"){
						alert("Done :"+data.uuid)
					}

					$(":text").val("")
					$(":password").val("")

				},
				error:function(XMLHttpRequest,textStatus,errorThrown){
					alert(textStatus+":"+errorThrown)
				},
				beforeSend: function(){
					// alert("processing...")
				},
			});
			return false;

		};


		
		$("#email").bind("blur",checkEmail);
		$("#nickname").bind("blur",checkNickName);
		$("#pwd").bind("blur",checkPwd);
		$("#repwd").bind("blur",checkRepwd);

		$("#reg").bind('click', function(){
			console.log("exec click");
			newAccount();
		} );

		$("#email").keydown(function(event) {
			if(event.keyCode==13){
				$("#nickname").focus();
			}
			// return false;
		});
		$("#nickname").keydown(function(event) {
			if(event.keyCode==13){
				$("#pwd").focus();
			}
		});
		$("#pwd").keydown(function(event) {
			if(event.keyCode==13){
				$("#repwd").focus();
			}
		});
		$("#repwd").keydown(function(event) {
			if(event.keyCode==13){
				$("#reg").focus();
				return false;
			}
		});

		$("#reg").keydown(function(event) {
			if(event.keyCode==13){
				return false
			}
		});

		var oldEmail;
		// var 
		function checkEmail(){
			var email = $("#email");
			var parent = email.parent().parent();
			if(email.val()==""){
				email.next("span").html("请输入邮箱地址").show();
				if(!parent.hasClass("error")){
					parent.addClass("error");
				};
				return false;
			}
			else if(email.val()!="" && !checkMailFormat(email.val())){
				email.next("span").html("邮箱格式错误").show();
				if(!parent.hasClass("error")){
					parent.addClass("error");
				};
				return false;
			}
			// else{
			// 	//   if(parent.hasClass("error")){
			// 	// 	parent.removeClass("error");
			// 	// };
			// 	// email.next("span").hide();
			// }
			// checking email is used
			// alert(email.val());
			if(oldEmail!=email.val()){
				$.ajax({
					url:'/account/checking/',
					dataType:'json',
					type:'GET',
					data:{
						type:'E',
						value:email.val()
					},
					success:function(data,textStatus){
						// alert(data.status)
						// alert(textStatus)
						if(data.status==="N"){
							email.next("span").html("邮箱地址可使用").show();
							if(parent.hasClass("error")){
								parent.removeClass("error");
							};
							// email.next("span").hide();
						}else if(data.status==="Y"){
							if(!parent.hasClass("error")){
								parent.addClass("error");
							};
							email.next("span").html("邮件已被注册,请更换其他邮箱.").show();
							return false;
						}
						// alert(textStatus);
					},
					error:function(d,textStatus){
						alert(textStatus);
						return false;
					}
				});
				oldEmail=email.val();
			}
			return (!parent.hasClass("error"))
		};

		var oldNickname
		function checkNickName(){
			var nickname =$("#nickname");
			var value = nickname.val().trim()
			var parent = nickname.parent().parent();
			if (value==""){
				if(!parent.hasClass("error")){
					parent.addClass("error");
				};
				console.log("empty");
				nickname.next("span").html("请设置昵称").show();
				return false;
			}
			else if(value.length>20){
				if(!parent.hasClass("error")){
					parent.addClass("error");
				};
				nickname.next("span").html("请昵称字符不能超过20个").show();
				return false;
			}

			if(oldNickname!=value){
				$.ajax({
					url: '/account/checking/',
					type: 'GET',
					dataType: 'json',
					data:{
							type:'N',
							value:value
						},
					success:function(data,textStatus) {
							if(data.status==="N"){
								nickname.next("span").html("昵称可使用").show();
								if(parent.hasClass("error")){
									parent.removeClass("error");
								};
								email.next("span").hide();
							}else if(data.status==="Y"){
								if(!parent.hasClass("error")){
									parent.addClass("error");
								};
								nickname.next("span").html("昵称已被使用").show();
								return false;
							}
						},
					error: function(d,textStatus){
						alert(textStatus);
						return false;
					}
				});
				oldNickname=value;
			}
			return (!parent.hasClass("error"))
		};

		function checkPwd(){
			var pwd=$("#pwd");
			var parent = pwd.parent().parent();
			if(pwd.val()==""){
				if(!parent.hasClass("error")){
					parent.addClass("error");
				};
				pwd.next("span").html("请输入密码").show();
				return false;
			}else if(pwd.val().length<6 || pwd.val().length>20){
				if(!parent.hasClass("error")){
					parent.addClass("error");
				};
				pwd.next("span").html("密码长度6-20位.").show();
				return false;
			}else{
				if(parent.hasClass("error")){
				parent.removeClass("error");
				};
				pwd.next("span").hide();
			};
			return true;
		};
		
		function checkRepwd(){
			var repwd=$("#repwd");
			var parent = repwd.parent().parent();
			if(repwd.val()!=$("#pwd").val()){
				if(!parent.hasClass("error")){
					parent.addClass("error");
				};
				repwd.next("span").html("两次输入密码不一致.").show();
				return false;
			}else{
				if(parent.hasClass("error")){
					parent.removeClass("error");
				};
				repwd.next("span").hide();
			};
			return true;
	};
		
</script>
{% endblock %}